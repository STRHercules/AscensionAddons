local rareMobs1 = {
    "7:XT",
    "Abominable Yeti",
    "Absolute Zero",
    "Abyss-Hunter",
    "Accursed Slitherblade",
    "Achellios the Banished",
    "Adazekar",
    "Adranus",
    "Aean Swiftriver",
    "Akkrilus",
    "Akour Qel",
    "Alluvion",
    "Alshirr Banebreath",
    "Ambassador Bloodrage",
    "Ambassador Jerrikar",
    "Ana-Mouz",
    "Ancient Guardian",
    "Ancient Irontree",
    "Antilos",
    "Anubisath Enforcer",
    "Aotona",
    "Apothecary Falthis",
    "Aramachus",
    "Araga",
    "Arash-ethis",
    "Arboreal Gulper",
    "Arcturis",
    "Asara",
    "Avalanchion",
    "Avalanche Walker",
    "Azzere the Skyblade",
    "Azurous",
    "Baron Bloodbane",
    "Baron Charr",
    "Barnabus",
    "Bayne",
    "Beastmaster Tivan",
    "Berylgos",
    "Big Samras",
    "Bjarn",
    "Blackmoss the Fetid",
    "Blazewing",
    "Blastilisk",
    "Blistermaw",
    "Bloodpetal Thirster",
    "Bloodroar the Stalker",
    "Boahn",
    "Bog Lurker",
    "Bone Witch",
    "Boulderheart",
    "Brack",
    "Brainwashed Noble",
    "Branch Snapper",
    "Bro'Gaz the Clanless",
    "Broken Tooth",
    "Brokespear",
    "Brontus",
    "Brother Ravenoak",
    "Captain Armistice",
    "Captain Bo'kar",
    "Captain Flat Tusk",
    "Captain Gerogg Hammertoe",
    "Captain Krosh",
    "Captain Taveir",
    "Captured Worgen",
    "Carnivous the Breaker",
    "Cascade",
    "Cerberus",
    "Chief Engineer Ishkar",
    "Chief Engineer Lorthander",
    "Chilling Mote",
    "Clack the Reaver",
    "Clobex",
    "Coilfang Emissary",
    "Collidus the Warp-Watcher",
    "Consuming Spectre",
    "Crazed Indu'le Survivor",
    "Creepthess",
    "Crippler",
    "Crusty",
    "Cursed Centaur",
    "Cyclok the Mad",
    "Dalaran Spellscribe",
    "Darbel Montrose",
    "Darkhound Alpha",
    "Darkslayer Mordenthal",
    "Dart Frog",
    "Darthalia Ebonscorch",
    "Darting Hatchling",
    "Dart",
    "Death Flayer",
    "Death Knight Soulbearer",
    "Deathshadow Champion",
    "Deathskitter",
    "Deathspeaker Selendre",
    "Deeb",
    "Deviate Faerie Dragon",
    "Devious Fireleaper",
    "Diamond Head",
    "Digger Flameforge",
    "Digmaster Shovelphlange",
    "Dirkee",
    "Diseased Remnant",
    "Dishu",
    "Divine Steed",
    "Doomcaster Suprax",
    "Doomsayer Jurim",
    "Dr. Whitherlimb",
    "Dragonmaw Battlemaster",
    "Dragonmaw Champion",
    "Dreamwatcher Forktongue",
    "Dreadwhisper",
    "Drillmaster Zurok",
    "Drogoth the Roamer",
    "Duke Ragereaver",
    "Duskstalker",
    "Dustwraith",
    "Echo of Ursoc's Rage",
    "Edan the Howler",
    "Elder Barbscale Crocolisk",
    "Elder Hydra",
    "Elder Mystic Razorsnout",
    "Eldinarcus",
    "Emogg the Crusher",
    "Enforcer Emilgund",
    "Engineer Whirleygig",
    "Escaped Imp",
    "Ever-Core the Punisher",
    "Faulty War Golem",
    "Fedfennel",
    "Felendor the Accuser",
    "Felfire Hawk",
    "Fellicent's Shade",
    "Felweaver Scornn",
    "Fenissa the Assassin",
    "Fenros",
    "Fingat",
    "Firecaller Radison",
    "Firewing Bloodwarder Elite",
    "Flagglemurk the Cruel",
    "Fluffy",
    "Foe Reaper 4000",
    "Foreman Grills",
    "Foreman Jerris",
    "Foreman Marcrid",
    "Foulmane",
    "Foulbelly",
    "Frostbite Totem",
    "Frostcursed Chimera",
    "Fulgorge",
    "Fumblub Gearwind",
    "Fury Shelda",
    "G'huurak",
    "Garneg Charskull",
    "Gash'nak the Cannibal",
    "Gatekeeper Rageroar",
    "General Colbatann",
    "General Erodus",
    "General Fangferror",
    "General Zarathura",
    "Geolord Mottle",
    "Geomancer Flintdagger",
    "Gesharahan",
    "Ghost Howl",
    "Gibberwilt",
    "Gibblesnik",
    "Gilmorian",
    "Gish the Unmoving",
    "Glazer",
    "Gluggle",
    "Gnarl Leafbrother",
    "Gnawbone",
    "Gondria",
    "Gordunni Soulreaper",
    "Goretooth",
    "Gorgon'och",
    "Gorefang",
    "Grash Thunderbrew",
    "Great Father Arctikus",
    "Greater Firebird",
    "Greedy Demon",
    "Gretheer",
    "Griegen",
    "Grimmaw",
    "Grizzlak",
    "Grizzle Snowpaw",
    "Grizzy",
    "Grocklar",
    "Grubthor",
    "Gruff Swiftbite",
    "Gruff",
    "Gruklash",
    "Grunter",
    "Grypholith",
    "Gwendal the Watcher",
    "Haarka the Ravenous",
    "Hagg Taurenbane",
    "Hahk'Zor",
    "Hammerspine",
    "Hannah Bladeleaf",
    "Harb Foulmountain",
    "Haruuma",
    "Hayoc",
    "Heartrazor",
    "Hed'mush the Rotting",
    "Heggin Stonewhisker",
    "Hemathion",
    "High General Abbendis",
    "High Priestess Hai'watna",
    "High Thane Jorfus",
    "Highlord Mastrogonde",
    "Hildana Deathstealer",
    "Hissperak",
    "Houndmaster Kerrax",
    "Humar the Pridelord",
    "Huricanian",
    "Icehorn",
    "Illidari Felguard",
    "Immolatus",
    "Imp Mother Laglath",
    "Inferno Totem",
    "Ironback",
    "Ironspine Chomper",
    "Ironspine Forgelord",
    "Ironspine Gazer",
    "Ironspine Petrifier",
    "Ironspine Threshalisk",
    "Ironspine Forgemaster",
    "Ironspine",
    "Ironeye the Invincible",
    "Jade Cloud Serpent",
    "Jade Crane Chick",
    "Jade Hatchling",
    "Jade Ooze",
    "Jade Owl",
    "Jade Panda",
    "Jade Pandaren Kite",
    "Jade Pandaren Kite String",
    "Jade Panther",
    "Jade Primordial Direhorn",
    "Jade Rockbound",
    "Jade Sludge",
    "Jade Stonecrusher",
    "Jade Tentacle",
    "Jade Tiger",
    "Jade Water Strider",
    "Jadefire Betrayer",
    "Jadefire Bound",
    "Jadefire Felsworn",
    "Jadefire Hellcaller",
    "Jadefire Rogue",
    "Jadefire Satyr",
    "Jadefire Shadowstalker",
    "Jadefire Spirit",
    "Jadefire Trickster",
    "Jademir Boughguard",
    "Jademir Dragonspawn",
    "Jademir Oracle",
    "Jademir Tree Warder",
    "Jadenvis Seawatcher",
    "Jadespine Basilisk",
    "Jade",
    "Jalinde Summerdrake",
    "Jimmy the Bleeder",
    "Jin'Zallah the Sandbringer",
    "Karaval",
    "Kazimp the Wicked",
    "Kazon",
    "Kashoch the Reaver",
    "Kelemis the Lifeless",
    "Kelivex Autumnvale",
    "King Krush",
    "King Mosh",
    "King Ping",
    "King Voras",
    "Korathaexis",
    "Kovork",
    "Kraator",
    "Kregg Keelhaul",
    "Krellack",
    "Krethis Shadowspinner",
}
local rareMobs2 = {
    "Lady Hederine",
    "Lady Moongazer",
    "Lady Sesspira",
    "Lady Shav'rar",
    "Lady Szallah",
    "Lady Vespia",
    "Lady Vespira",
    "Lady Zephris",
    "Lapress",
    "Large Loch Crocolisk",
    "Leech Widow",
    "Leprithus",
    "Levinia",
    "Licillin",
    "Lilith the Lithe",
    "Lilith",
    "Lizzle Sprysprocket",
    "Lo'Grosh",
    "Loque'nahak",
    "Lord Angler",
    "Lord Captain Wyrmak",
    "Lord Condar",
    "Lord Darkscythe",
    "Lord Malathrom",
    "Lord Maldazzar",
    "Lord Sinslayer",
    "Lost One Chieftain",
    "Lost One Cook",
    "Lost Soul",
    "Lucy",
    "Lumbering Horror",
    "Lupos",
    "Ma'ruk Wyrmscale",
    "Magister Hawkhelm",
    "Magma Titan",
    "Magosh",
    "Magronos the Unyielding",
    "Mal'druk the Soulrender",
    "Malestra Dusksoul",
    "Malgin Barleybrew",
    "Malfunctioning Reaver",
    "Mana Devourer",
    "Mana Hunter",
    "Marcus Bel",
    "Marisa du'Paige",
    "Marsh Baron Brok",
    "Marticar",
    "Master Digger",
    "Master Feardred",
    "Mawrat Hunter",
    "Mawrat Stalker",
    "Mawreaper",
    "Mekthorg the Wild",
    "Meshlok the Harvester",
    "Mezzir the Howler",
    "Mindless Zealot",
    "Miner Johnson",
    "Mirelow",
    "Mistress Dominix",
    "Mist Howler",
    "Mith'rethis the Enchanter",
    "Mojo the Twisted",
    "Molok the Crusher",
    "Mongress",
    "Monnos the Elder",
    "Morcrush",
    "Morgaine the Sly",
    "Mother Fang",
    "Mother Rosula",
    "Mr. Crabs",
    "Mr. Grabby",
    "Muad",
    "Mugglefin",
    "Murkarazon",
    "Murloc the Warlock",
    "Mushgog",
    "Naraxis",
    "Narg the Taskmaster",
    "Narillasanz",
    "Necromantic Lich",
    "Nefaru",
    "Nerubian Overseer",
    "Nimar the Slayer",
    "Nourath Qel",
    "Nuramoc",
    "Oakpaw",
    "Obsidian Crusher",
    "Okrek",
    "Old Cliff Jumper",
    "Old Crystalbark",
    "Old Grizzlegut",
    "Old Vicejaw",
    "Olm the Wise",
    "Omgorn the Lost",
    "Oooze",
    "Oozeworm",
    "Ordeus",
    "Orgrim Doomhammer",
    "Orix the All-Seer",
    "Orumo the Observer",
    "Overseer Malah",
    "Perobas the Bloodthirster",
    "Pit Lord Vilemus",
    "Plague Shambler",
    "Priest of Kethrazor",
    "Priestess of Elune",
    "Prince Kellen",
    "Prince Nazjak",
    "Prince Raze",
    "Princess Tempestria",
    "Pridewing Patriarch",
    "Prognar",
    "Puscilla",
    "Putridius",
    "Putridus the Ancient",
    "Pyrava",
    "Qirot",
    "Ragepaw",
    "Raijuu",
    "Rak'shiri",
    "Ranger Lord Hawkspear",
    "Rathorian",
    "Ravasaur Matriarch",
    "Ravaged Cadaver",
    "Ravaged Corpse",
    "Ravaged Cavedweller Worg",
    "Ravaged Crystalline Ice Giant",
    "Ravaged Ghoul",
    "Ravager Ambusher",
    "Ravager Hatchling",
    "Ravager Specimen",
    "Ravage",
    "Ravenclaw Regent",
    "Ravenous Flayer Matriarch",
    "Ravenous Fungal Giant",
    "Razormaw Matriarch",
    "Razortalon",
    "Razorthorn Flayer Matriarch",
    "Rekk'tilac",
    "Ressan the Needler",
    "Retherokk the Berserker",
    "Rex Ashil",
    "Rezira the Seer",
    "Ribchaser",
    "Rikkilea Flitterling",
    "Rippa",
    "Ripscale",
    "Ro'Bark",
    "Rohh the Silent",
    "Roloch",
    "Rorgish Jowl",
    "Rot Hide Bruiser",
    "Ruul Onestone",
    "Sable",
    "Sand Widow",
    "Sandarr Dunereaver",
    "Sandstorm Elemental",
    "Sandworm",
    "Satyr Lord Xavale",
    "Scale Belly",
    "Scalded Basilisk",
    "Scalder",
    "Scalding Broodling",
    "Scalding Drake",
    "Scalding Elemental",
    "Scalding Whelp",
    "Scald",
    "Scarlet Executioner",
    "Scarlet High Clerist",
    "Scarlet Highlord Daion",
    "Scarlet Interrogator",
    "Scarlet Judge",
    "Scarlet Smith",
    "Scarlet Tracker",
    "Scargil",
    "Scillia Daggerquil",
    "Scourge Assassin",
    "Seeker Aqualon",
    "Seething Hate",
    "Sentinel Amarassan",
    "Seraphina Bloodheart",
    "Seraphina",
    "Serra Mountainhome",
    "Shadow Gorger",
    "Shadowforge Commander",
    "Shadowsworn Assassin",
    "Shadowsworn Drakonid Champion",
    "Shady Dealer",
    "Shard-Hide Felboar",
    "Shanda the Spinner",
    "Shivarra",
    "Shleipnarr",
    "Siege Golem",
    "Silithid Harvester",
    "Silithid Ravager",
    "Singer",
    "Sister Hatelash",
    "Sister Rathtalon",
    "Sister Riven",
    "Sister Subversia",
    "Skarr the Unbreakable",
    "Skhowl",
    "Skreeg the Devourer",
    "Skoll",
    "Slark",
    "Slave Master Blackheart",
    "Sleeping Dragon",
    "Sludge Beast",
    "Sludginn",
    "Smoldar",
    "Snagglespear",
    "Snarlflare",
    "Snarlmane",
    "Snort the Heckler",
    "Son of Anzu",
    "Soriid the Devourer",
    "Sorrow Wing",
    "Soul of Tanaris",
    "Soulseeker",
    "Soultwisted Monstrosity",
    "Speaker Mar'grom",
    "Spirit of the Damned",
    "Spiteflayer",
    "Spitelash Stormseer",
    "Squadron Commander Vishax",
    "Squiddic",
    "Sri'skulk",
    "Staggon",
    "Stalker Ebonclaw",
    "Stone Cold Snappy",
    "Stone Fury",
    "Stonearm",
    "Storm Howl",
    "Strider Clutchmother",
    "Subjugator Yalqiz",
    "Surge",
    "Surgeon Stitchflesh",
    "Swift Serpent",
    "Swiftmane",
    "Swinegart Spearhide",
    "Syaith",
    "Syreian the Bonecarver",
    "Tagar Spinebreaker",
    "Takk the Leaper",
    "Talixae Flamewreath",
    "Taskmaster Whipfang",
    "Tempest Totem",
    "Tepolar",
    "Teralis",
    "Terror Spinner",
    "Terrorspark",
    "Terrowulf Packlord",
    "The Behemoth",
    "The Evalcharr",
    "The Harbringer",
    "The Husk",
    "The Many-Faced Devourer",
    "The Ongar",
    "The Rake",
    "The Razza",
    "The Reak",
    "The Rot",
    "The Unknown Soldier",
    "The Windreaver",
    "Thokian Devilsaur",
    "Thora Feathermoon",
    "Threggil",
    "Thurmonde the Devout",
    "Thunder Howl",
    "Thunderclaw",
    "Thunderhead Hunter",
    "Thunderstomp Stegodon",
    "Thunderstomp",
    "Tidelord Rrurgaz",
    "Time-Lost Proto Drake",
    "Tormented Spirit",
    "Torroc",
    "Tregla",
    "Trigore the Lasher",
    "Tukemuth",
    "Twilight Lord Everun",
    "Uhk'loc",
    "Un'goro Hurler",
    "Unbound Earth Spirit",
    "Unbound Fire Spirit",
    "Unbound Water Spirit",
    "Unbound Wind Spirit",
    "Unstable Shade",
    "Unstable Warp Hunter",
    "Uruson",
    "Ursol'lok",
    "Varo'then's Ghost",
    "Vengeful Ancient",
    "Veyzhak the Cannibal",
    "Vigdis the War Maiden",
    "Vile Sting",
    "Vixx the Collector",
    "Voidhunter Yar",
    "Volchan",
    "Vorakem",
    "Vorixus the Forlorn",
    "Vrax'thul",
    "Vultros",
    "War Golem",
    "Warboss Nekrogg",
    "Warleader Krazzilak",
    "Warmaul Head-Splitter",
    "Warlord Kolkanis",
    "Warlord Thresh'jin",
    "Watch Commander Zalaphil",
    "Wep",
    "Widowed Murloc Queen",
    "Witherheart the Stalker",
    "Xav the Unfallen",
    "Xullorax",
    "Zalas Witherbark",
    "Zaricotl",
    "Zekkis",
    "Zelphael",
    "Zerillis",
    "Zora",
    "Zul'arek Hatefowler",
    "Zul'drak Sentinel",
    "Zul'gamux",
}

local falsePositives = {
    ["Dart Frog"] = 3,
    ["Darthalia Ebonscorch"] = 2,
    ["Darting Hatchling"] = 1,

    ["Ironspine Chomper"] = 6,
    ["Ironspine Forgelord"] = 5,
    ["Ironspine Gazer"] = 4,
    ["Ironspine Petrifier"] = 3,
    ["Ironspine Threshalisk"] = 2, --works as ascended

    ["Jade Cloud Serpent"] = 31,
    ["Jade Crane Chick"] = 30,
    ["Jade Hatchling"] = 29,
    ["Jade Ooze"] = 28,
    ["Jade Owl"] = 27,
    ["Jade Panda"] = 26,
    ["Jade Pandaren Kite"] = 25,
    ["Jade Pandaren Kite String"] = 24,
    ["Jade Panther"] = 23,
    ["Jade Primordial Direhorn"] = 22,
    ["Jade Rockbound"] = 21,
    ["Jade Sludge"] = 20,
    ["Jade Stonecrusher"] = 19,
    ["Jade Tentacle"] = 18,
    ["Jade Tiger"] = 17,
    ["Jade Water Strider"] = 16,
    ["Jadefire Betrayer"] = 15,
    ["Jadefire Bound"] = 14,
    ["Jadefire Felsworn"] = 13,
    ["Jadefire Hellcaller"] = 12,
    ["Jadefire Rogue"] = 11,
    ["Jadefire Satyr"] = 10,
    ["Jadefire Shadowstalker"] = 9,
    ["Jadefire Spirit"] = 8,
    ["Jadefire Trickster"] = 7,
    ["Jademir Boughguard"] = 6,
    ["Jademir Dragonspawn"] = 5,
    ["Jademir Oracle"] = 4,
    ["Jademir Tree Warder"] = 3,
    ["Jadenvis Seawatcher"] = 2,
    ["Jadespine Basilisk"] = 1,

    ["Scalded Basilisk"] = 6,
    ["Scalder"] = 5,
    ["Scalding Broodling"] = 4,
    ["Scalding Drake"] = 3,
    ["Scalding Elemental"] = 2,
    ["Scalding Whelp"] = 1,

    ["Thunderstomp Stegodon"] = 1,

    ["Ravaged Cadaver"] = 8,
    ["Ravaged Corpse"] = 7,
    ["Ravaged Cavedweller Worg"] = 6,
    ["Ravaged Crystalline Ice Giant"] = 5,
    ["Ravaged Ghoul"] = 4,
    ["Ravager Ambusher"] = 3,
    ["Ravager Hatchling"] = 2,
    ["Ravager Specimen"] = 1,

    ["Seraphina Bloodheart"] = 1,

    ["Lilith the Lithe"] = 1
}

local blockedZones = {
    -- Major Cities
    ["Shattrath City"] = true,
    ["Orgrimmar"] = true,
    ["Stormwind City"] = true,
    ["Ironforge"] = true,
    ["Darnassus"] = true,
    ["Thunder Bluff"] = true,
    ["Undercity"] = true,
    ["Dalaran"] = true,
    ["Exodar"] = true,
    ["Silvermoon City"] = true,
    ["Booty Bay"] = true,
    
    -- Battlegrounds
    ["Warsong Gulch"] = true,
    ["Arathi Basin"] = true,
    ["Alterac Valley"] = true,
    ["Eye of the Storm"] = true,
    ["Strand of the Ancients"] = true,
    ["Isle of Conquest"] = true,
    
    -- Arena Areas
    ["Blade's Edge Arena"] = true,
    ["Nagrand Arena"] = true,
    ["Ruins of Lordaeron"] = true,
    ["Dalaran Arena"] = true,
    ["The Ring of Valor"] = true,

    -- TBC Dungeons
    ["Hellfire Ramparts"] = true,
    ["The Blood Furnace"] = true,
    ["The Shattered Halls"] = true,
    ["The Slave Pens"] = true,
    ["The Underbog"] = true,
    ["The Steamvault"] = true,
    ["Mana-Tombs"] = true,
    ["Auchenai Crypts"] = true,
    ["Sethekk Halls"] = true,
    ["Shadow Labyrinth"] = true,
    ["Old Hillsbrad Foothills"] = true,
    ["The Black Morass"] = true,
    ["The Arcatraz"] = true,
    ["The Botanica"] = true,
    ["The Mechanar"] = true,
    ["Magisters' Terrace"] = true,

    -- TBC Raids
    ["Karazhan"] = true,
    ["Gruul's Lair"] = true,
    ["Magtheridon's Lair"] = true,
    ["Serpentshrine Cavern"] = true,
    ["The Eye"] = true,
    ["Battle for Mount Hyjal"] = true,
    ["Black Temple"] = true,
    ["Sunwell Plateau"] = true,
    ["Zul'Aman"] = true
}

local targetButton = nil
local currentIndex1 = 1
local currentIndex2 = 1
local scanTicker1 = nil
local scanTicker2 = nil
local recentlyFoundRares = {}
local recentlyFoundCleanupTicker = nil
local mapCheckTicker = nil
local ScanRares

-- Create lookup tables for quick existence checks:
local rareMobs1Lookup = {}
local rareMobs2Lookup = {}

for i, name in ipairs(rareMobs1) do
    rareMobs1Lookup[name] = true
end

for i, name in ipairs(rareMobs2) do
    rareMobs2Lookup[name] = true
end

local function CreateTargetButton()
    if not targetButton then
        targetButton = CreateFrame("Button", "RareTargetButton", UIParent, "SecureActionButtonTemplate")
        targetButton:SetSize(120, 40)
        targetButton:SetPoint("RIGHT", UIParent, "RIGHT", -300, 0)
        
        targetButton:SetBackdrop({
            bgFile = "Interface/Tooltips/UI-Tooltip-Background",
            edgeFile = "Interface/Tooltips/UI-Tooltip-Border",
            tile = true,
            tileSize = 16,
            edgeSize = 16,
            insets = { left = 4, right = 4, top = 4, bottom = 4 }
        })
        targetButton:SetBackdropColor(0, 0, 0, 0.8)
        targetButton:SetBackdropBorderColor(0.6, 0.6, 0.6, 1)

        local text = targetButton:CreateFontString(nil, "OVERLAY", "GameFontHighlight")
        text:SetPoint("CENTER")
        text:SetText("Target Rare")
        
        -- Create close button
        local closeButton = CreateFrame("Button", nil, targetButton)
        closeButton:SetSize(20, 20)
        closeButton:SetPoint("TOPRIGHT", targetButton, "TOPRIGHT", -2, -2)
        
        closeButton:SetNormalTexture("Interface\\Buttons\\UI-Panel-MinimizeButton-Up")
        closeButton:SetPushedTexture("Interface\\Buttons\\UI-Panel-MinimizeButton-Down")
        closeButton:SetHighlightTexture("Interface\\Buttons\\UI-Panel-MinimizeButton-Highlight", "ADD")
        
        closeButton:SetScript("OnClick", function()
            targetButton:Hide()
        end)
        
        targetButton:Hide()
    end
    return targetButton
end

local function StopScanners()
    if scanTicker1 then
        scanTicker1:Cancel()
        scanTicker1 = nil
    end
    if scanTicker2 then
        scanTicker2:Cancel()
        scanTicker2 = nil
    end
    if mapCheckTicker then
        mapCheckTicker:Cancel()
        mapCheckTicker = nil
    end
end

local function TryShowTargetButton(targetName)
    if UnitAffectingCombat("player") then
        C_Timer.After(1, function()
            TryShowTargetButton(targetName)
        end)
    else
        local button = CreateTargetButton()
        if button then
            button:SetAttribute("type", "macro")
            button:SetAttribute("macrotext", "/target " .. targetName .. "\n/run SetRaidTarget('target', 1)")
            button:Show()
        else
            print("|cFF00FF00AAC_RareScanner|r: Error creating target button.")
        end
    end
end

local function CleanupRecentlyFoundRares()
    local currentTime = GetTime()
    for rareName, timeFound in pairs(recentlyFoundRares) do
        if (currentTime - timeFound) > 200 then
            recentlyFoundRares[rareName] = nil
        end
    end
end

local function ProcessRareMobFound(targetName)
    recentlyFoundRares[targetName] = GetTime()
    print("|cFF00FF00AAC_RareScanner|r: Rare Mob found! " .. targetName)
    print("|cFF00FF00AAC_RareScanner|r: Rare Mob found! " .. targetName)
    print("|cFF00FF00AAC_RareScanner|r: Rare Mob found! " .. targetName)
    PlaySoundFile("Sound\\Interface\\AlarmClockWarning3.wav")
    TryShowTargetButton(targetName)
end

ScanRares = function()
    currentIndex1 = 1
    currentIndex2 = 1
    StopScanners()
    
    -- Stop existing cleanup ticker if running
    if recentlyFoundCleanupTicker then
        recentlyFoundCleanupTicker:Cancel()
        recentlyFoundCleanupTicker = nil
    end
    
    -- Stop existing map check ticker if running
    if mapCheckTicker then
        mapCheckTicker:Cancel()
        mapCheckTicker = nil
    end
    
    local E, L, V, P, G
    if ElvUI then E, L, V, P, G = unpack(ElvUI) end
    if E and E.db and E.db.general then
        E.db.general.taintLog = true
        E:Print("|cFF00FF00AAC_RareScanner|r: Taint-Log activated.")
    end

    local currentZone = GetZoneText()
    local currentSubZone = GetSubZoneText()
    if blockedZones[currentZone] then
        print("|cFF00FF00AAC_RareScanner|r: Current zone (" .. currentZone .. ") is blocked. Scanner not starting.")
        return -- Don't start the scanner in a blocked zone
    elseif blockedZones[currentSubZone] then
        print("|cFF00FF00AAC_RareScanner|r: Current zone (" .. currentSubZone .. ") is blocked. Scanner not starting.")
        return -- Don't start the scanner in a blocked zone
    end

    -- Start the cleanup ticker for recently found rares (every 30 seconds)
    recentlyFoundCleanupTicker = C_Timer.NewTicker(30, CleanupRecentlyFoundRares)
    
    -- Start map check ticker to monitor WorldMapFrame status
    mapCheckTicker = C_Timer.NewTicker(0.1, function()
        if WorldMapFrame and WorldMapFrame:IsShown() then
            -- Map is open, pause scanning
            if scanTicker1 then
                scanTicker1:Cancel()
                scanTicker1 = nil
            end
            if scanTicker2 then
                scanTicker2:Cancel()
                scanTicker2 = nil
            end
        else
            -- Map is closed, resume scanning if not already running
            if not scanTicker1 then
                scanTicker1 = C_Timer.NewTicker(0.001, function()
                    local currentZone = GetZoneText()
                    local currentSubZone = GetSubZoneText()
                    if blockedZones[currentZone] or blockedZones[currentSubZone] then
                        StopScanners()
                        return
                    end

                    local targetName = rareMobs1[currentIndex1]
                    
                    -- Check if rare was recently found BEFORE targeting
                    if recentlyFoundRares[targetName] then
                        if falsePositives[targetName] then
                            currentIndex1 = currentIndex1 + falsePositives[targetName] + 1
                        else
                            currentIndex1 = currentIndex1 + 1
                        end
                        if currentIndex1 > #rareMobs1 then currentIndex1 = 1 end
                        return
                    end
                    
                    TargetUnit(targetName)
                    if StaticPopup1 and StaticPopup1:IsVisible() and StaticPopup1Text:GetText():find("AAC_RareScanner") then
                        StaticPopup1Button1:Click()
                        EnableAddOn("AAC_RareScanner")
                        if falsePositives[targetName] then
                            recentlyFoundRares[targetName] = GetTime() -- Auch false positives temporär blockieren
                            currentIndex1 = currentIndex1 + falsePositives[targetName]
                            if currentIndex1 > #rareMobs1 then currentIndex1 = 1 end
                        elseif rareMobs1Lookup[targetName] then
                            ProcessRareMobFound(targetName)
                        end
                    end
                    currentIndex1 = currentIndex1 + 1
                    if currentIndex1 > #rareMobs1 then currentIndex1 = 1 end
                end)
            end

            if not scanTicker2 then
                scanTicker2 = C_Timer.NewTicker(0.001, function()
                    local currentZone = GetZoneText()
                    local currentSubZone = GetSubZoneText()
                    if blockedZones[currentZone] or blockedZones[currentSubZone] then
                        StopScanners()
                        return
                    end

                    local targetName = rareMobs2[currentIndex2]
                    
                    -- Check if rare was recently found BEFORE targeting
                    if recentlyFoundRares[targetName] then
                        if falsePositives[targetName] then
                            currentIndex2 = currentIndex2 + falsePositives[targetName] + 1
                        else
                            currentIndex2 = currentIndex2 + 1
                        end
                        if currentIndex2 > #rareMobs2 then currentIndex2 = 1 end
                        return
                    end
                    
                    TargetUnit(targetName)
                    if StaticPopup1 and StaticPopup1:IsVisible() and StaticPopup1Text:GetText():find("AAC_RareScanner") then
                        StaticPopup1Button1:Click()
                        EnableAddOn("AAC_RareScanner")
                        if falsePositives[targetName] then
                            recentlyFoundRares[targetName] = GetTime() -- Auch false positives temporär blockieren
                            currentIndex2 = currentIndex2 + falsePositives[targetName]
                            if currentIndex2 > #rareMobs2 then currentIndex2 = 1 end
                        elseif rareMobs2Lookup[targetName] then
                            ProcessRareMobFound(targetName)
                        end
                    end
                    currentIndex2 = currentIndex2 + 1
                    if currentIndex2 > #rareMobs2 then currentIndex2 = 1 end
                end)
            end
        end
    end)
end

local eventFrame = CreateFrame("Frame")
eventFrame:RegisterEvent("PLAYER_ENTERING_WORLD")
eventFrame:RegisterEvent("ZONE_CHANGED")
eventFrame:SetScript("OnEvent", function(self, event, ...)
    if event == "PLAYER_ENTERING_WORLD" then
        print("|cFF00FF00AAC_RareScanner activated|r")
        print("Just ignore the Error: AddOn 'AAC_RareScanner' tainted the call of the secure function 'UNKNOWN()'")
        print("It is needed for the detection and comes up every now and then, especially when a false positive is around.")
        C_Timer.After(10, function()
            ScanRares()
        end)
    elseif event == "ZONE_CHANGED" then
        StopScanners()
        C_Timer.After(1, function()
            ScanRares()
        end)
    end
end)